#!/usr/bin/env bash

#
# This script starts the Cloudera Hadoop cluster
#


# Compute the path to directory that contains this script
readonly selfname=$(basename "$0")
readonly selfdir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null && pwd )"


function print_usage {
cat <<CAT
Usage:    $selfname --version <version> [--mount <mount> ] [ --auth <auth>] [ --sasl ] [ --tls ]
CAT
}


if ! [ -x "$(command -v sshpass)" ]; then
cat <<CAT
FATAL: sshpass not found!

You can install the missing tool as follows.
- macos
    brew install https://raw.githubusercontent.com/kadwanev/bigboybrew/master/Library/Formula/sshpass.rb
- linux
    yum install sshpass
    apt-get install sshpass
CAT
exit 1
fi


while [[ $# -gt 0 ]]; do
key="$1"
case $key in
    --help)
        print_usage
        exit 0
    ;;
    --classifier)
        image_classifier="$2"
        shift; shift
      ;;
    --version)
        cloudera_version="$2"
        shift; shift
      ;;
    --mount)
        mount="$2"
        case $mount in
          /*) mount=$mount;;
           *) mount=$PWD/$mount;;
        esac
        shift; shift
      ;;
    --auth)
        auth="$2"
        shift; shift
      ;;
    --sasl)
        sasl_protection="privacy"
        shift
      ;;
    --tls)
        tls_encryption="true"
        shift
      ;;
    *)
        shift
      ;;
esac
done


case ${cloudera_version} in
'5.4.2'|'5.16.1'|'6.0.1')
;;
*)
cat <<CAT
Error: missing or unsupported --version argument
       --version 5.4.2
       --version 5.16.1
       --version 6.0.1
CAT
exit -1
;;
esac


case ${auth} in
'simple'|'kerberos')
;;
*)
cat <<CAT
Error: missing or unsupported --auth argument
       --auth simple
       --auth kerberos
CAT
exit -1
;;
esac


# Define the default classifier
[[ "${image_classifier}x" == "x" ]] && image_classifier="$(git describe)"


export registry="registry.alpinedata.tech"
export repository="red/cloudera"
export image_version="$cloudera_version-$image_classifier"
export hadoop_auth="${auth}"
export mount="${mount:-$(pwd)/mount}"
export sasl_protection="${sasl_protection:-authentication}"
export tls_encryption="${tls_encryption:-false}"


cat <<CAT
-----------------------------------
Starting Cloudera Hadoop with
  - cloudera_version $cloudera_version
  - image_version    $image_version
  - hadoop_auth      $hadoop_auth
  - sasl_protection  $sasl_protection
  - tls_encryption   $tls_encryption
  - mount            $mount

CAT

docker-compose \
    --project-name cloudera-${cloudera_version} \
    --file $selfdir/docker-compose.yml \
    up --detach #> /dev/null 2>&1


#echo "Configuring SSH  ... "
#sleep 32
#ssh-keygen -R [edge.docker.net]:2222
#ssh-keyscan -p 2222 edge.docker.net >> ~/.ssh/known_hosts
#sshpass -p "alice" ssh-copy-id -f -p 2222 "alice@edge.docker.net"
#
#
#echo "Configuring Hadoop client ... "
#sleep 32
#$selfdir/client/configure --mount $mount
#exit 0
